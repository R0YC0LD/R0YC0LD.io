<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | MONOLITH EDITION v8.0</title>
    <meta name="description" content="High-Fidelity Web Audio Workstation">

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500;800&family=Rajdhani:wght@500;700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">

    <style>
        /* * ======================================================================================
         * BÖLÜM 1: CSS DEĞİŞKENLERİ VE TEMEL AYARLAR
         * ======================================================================================
         */
        :root {
            --color-bg-master: #050505;
            --color-bg-panel: #0a0a0c;
            --color-bg-surface: #111114;
            --color-border: #222226;
            
            --color-accent: #00e5ff;       /* Ana Neon Mavi */
            --color-accent-dim: rgba(0, 229, 255, 0.1);
            --color-secondary: #7000ff;    /* İkincil Mor */
            --color-danger: #ff0f4f;       /* Hata/Kayıt Kırmızı */
            --color-warning: #ffbe0b;      /* Uyarı Sarı */
            --color-success: #00ff9d;      /* Başarı Yeşil */
            
            --font-mono: 'JetBrains Mono', monospace;
            --font-display: 'Rajdhani', sans-serif;
            --font-ui: 'Inter', sans-serif;

            --size-header: 70px;
            --size-mixer: 350px;
            
            --anim-speed: 0.2s;
            --shadow-glow: 0 0 15px rgba(0, 229, 255, 0.3);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-bg-master);
            color: #e0e0e0;
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: grid;
            grid-template-rows: var(--size-header) 1fr var(--size-mixer);
        }

        /* SCROLLBAR TASARIMI */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-accent); }

        /* * ======================================================================================
         * BÖLÜM 2: YÜKLEME EKRANI (BOOT SEQUENCE)
         * ======================================================================================
         */
        #boot-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .boot-logo {
            font-family: var(--font-display); font-size: 64px; font-weight: 800;
            letter-spacing: 5px; color: #fff;
            text-shadow: 0 0 30px var(--color-accent);
            animation: flicker 3s infinite;
        }
        
        .boot-logo span { color: var(--color-accent); }

        .boot-terminal {
            width: 600px; height: 200px; background: #080808;
            border: 1px solid #333; padding: 20px; margin-top: 40px;
            font-family: var(--font-mono); font-size: 11px; color: var(--color-success);
            overflow: hidden; position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        
        .boot-line { margin-bottom: 4px; opacity: 0; animation: fadeInLine 0.1s forwards; }
        .boot-line.error { color: var(--color-danger); }
        .boot-line.warn { color: var(--color-warning); }

        .boot-progress {
            width: 600px; height: 4px; background: #222; margin-top: 10px;
            position: relative; overflow: hidden;
        }
        .boot-bar {
            width: 0%; height: 100%; background: var(--color-accent);
            box-shadow: 0 0 20px var(--color-accent);
            transition: width 0.1s linear;
        }

        .btn-start {
            margin-top: 30px; padding: 15px 50px;
            background: transparent; border: 2px solid var(--color-accent);
            color: var(--color-accent); font-family: var(--font-mono);
            font-size: 16px; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
            display: none; transition: 0.3s;
        }
        .btn-start:hover { background: var(--color-accent); color: #000; box-shadow: 0 0 40px var(--color-accent); }

        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 24%, 55% { opacity: 0.4; }
        }
        @keyframes fadeInLine { to { opacity: 1; } }

        /* * ======================================================================================
         * BÖLÜM 3: HEADER VE TOOLBAR
         * ======================================================================================
         */
        header {
            background: var(--color-bg-panel);
            border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; z-index: 1000;
        }

        .brand-area { display: flex; align-items: center; gap: 15px; }
        .app-title { font-family: var(--font-display); font-size: 24px; font-weight: 700; color: #fff; }
        .app-ver { font-family: var(--font-mono); font-size: 10px; background: #222; padding: 2px 6px; border-radius: 4px; color: #888; }

        .controls-area {
            display: flex; background: #000; border: 1px solid #222;
            padding: 8px; border-radius: 6px; gap: 10px;
        }

        .transport-btn {
            background: #151515; border: 1px solid #333; color: #ccc;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .transport-btn:hover { border-color: #666; color: #fff; }
        
        .btn-play.playing { background: var(--color-success); color: #000; border-color: var(--color-success); box-shadow: 0 0 15px var(--color-success); }
        .btn-stop:hover { border-color: var(--color-danger); color: var(--color-danger); }

        .display-lcd {
            background: #050505; border: 1px solid #333; border-radius: 4px;
            padding: 0 15px; display: flex; flex-direction: column; justify-content: center;
            height: 40px; width: 100px;
        }
        .lcd-label { font-size: 8px; color: #555; font-family: var(--font-mono); }
        .lcd-value { font-size: 16px; color: var(--color-accent); font-family: var(--font-mono); font-weight: bold; }
        
        .ai-generate-btn {
            background: linear-gradient(135deg, var(--color-secondary), var(--color-accent));
            border: none; color: #fff; padding: 0 25px; height: 40px; border-radius: 4px;
            font-weight: 800; font-size: 12px; cursor: pointer;
            box-shadow: 0 0 20px rgba(112,0,255,0.4); transition: 0.3s;
            display: flex; align-items: center; gap: 10px;
        }
        .ai-generate-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }

        /* * ======================================================================================
         * BÖLÜM 4: SEQUENCER ALANI (MAIN WORKSPACE)
         * ======================================================================================
         */
        #workspace {
            background: #080808; position: relative; overflow-y: auto; overflow-x: hidden;
            padding: 20px;
        }
        
        #workspace::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none;
        }

        .track-container { position: relative; z-index: 10; padding-bottom: 50px; }

        .track-row {
            display: flex; height: 64px; background: var(--color-bg-surface);
            margin-bottom: 6px; border: 1px solid var(--color-border); border-radius: 4px;
            transition: background 0.2s;
        }
        .track-row:hover { background: #1a1a1d; border-color: #444; }

        .track-header {
            width: 200px; padding: 10px 15px; border-right: 1px solid var(--color-border);
            display: flex; flex-direction: column; justify-content: center;
            background: #161619; position: relative;
        }
        .th-name { font-weight: 700; font-size: 13px; color: #eee; margin-bottom: 4px; }
        .th-type { font-size: 9px; color: var(--color-accent); font-family: var(--font-mono); text-transform: uppercase; }
        
        .step-sequencer {
            flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 4px; padding: 6px;
        }

        .step-btn {
            background: #000; border: 1px solid #222; border-radius: 2px;
            cursor: pointer; position: relative; transition: all 0.1s;
        }
        .step-btn:nth-child(4n+1) { background: #0c0c0c; } /* Beat marker */
        
        .step-btn:hover { border-color: #555; }
        .step-btn.active {
            background: var(--color-accent); border-color: var(--color-accent);
            box-shadow: 0 0 10px var(--color-accent);
        }
        
        .step-btn.playhead {
            background: #fff !important; transform: scale(1.1); z-index: 50;
        }

        /* * ======================================================================================
         * BÖLÜM 5: MIXER VE EFEKTLER
         * ======================================================================================
         */
        #mixer {
            background: #0c0c0f; border-top: 1px solid var(--color-border);
            padding: 20px; display: flex; gap: 10px; overflow-x: auto;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5); z-index: 500;
        }

        .channel-strip {
            width: 100px; height: 100%; background: #131316;
            border: 1px solid #222; border-radius: 4px;
            display: flex; flex-direction: column; padding: 10px;
            flex-shrink: 0; position: relative;
        }
        
        .channel-strip.master-channel {
            margin-left: auto; width: 120px; background: #0f0f13; border: 1px solid var(--color-secondary);
        }

        .strip-header { text-align: center; font-size: 10px; font-weight: bold; color: #777; margin-bottom: 10px; text-transform: uppercase; }
        
        /* FX RACK */
        .fx-slot {
            font-size: 9px; background: #000; color: #555;
            padding: 4px; margin-bottom: 4px; text-align: center;
            border: 1px solid #1a1a1a; cursor: pointer; transition: 0.2s;
        }
        .fx-slot:hover { color: #fff; border-color: #444; }
        .fx-slot.active {
            color: var(--color-accent); border-color: var(--color-accent);
            background: rgba(0, 229, 255, 0.05);
        }

        /* FADER */
        .fader-track {
            flex: 1; display: flex; justify-content: center; position: relative;
            margin-top: 10px;
        }
        
        /* Dikey Slider CSS Hack */
        input[type=range].vertical-fader {
            -webkit-appearance: none; width: 180px; height: 30px;
            background: transparent; transform: rotate(-90deg);
            margin-top: 70px; cursor: ns-resize;
        }
        
        input[type=range].vertical-fader::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #000; border-radius: 2px; border: 1px solid #222;
        }
        
        input[type=range].vertical-fader::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 10px; margin-top: -9px;
            background: #555; border: 1px solid #111; border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        
        .master-channel input[type=range].vertical-fader::-webkit-slider-thumb {
            background: var(--color-secondary); box-shadow: 0 0 10px var(--color-secondary);
        }

        /* VU METER */
        .vu-meter {
            position: absolute; right: 5px; top: 0; bottom: 0; width: 6px;
            background: #000; border-radius: 3px; overflow: hidden; pointer-events: none;
        }
        .vu-fill {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: linear-gradient(to top, var(--color-success), var(--color-warning), var(--color-danger));
            transition: height 0.05s ease-out; opacity: 0.8;
        }

        /* * ======================================================================================
         * BÖLÜM 6: POP-UP PENCERELER (AI & FX)
         * ======================================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }

        .modal-window {
            width: 600px; background: #111; border: 1px solid var(--color-secondary);
            border-radius: 8px; overflow: hidden; box-shadow: 0 0 100px rgba(0,0,0,0.8);
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-header {
            padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-family: var(--font-display); font-size: 20px; color: #fff; }
        .modal-close { cursor: pointer; font-size: 20px; color: #666; }
        .modal-close:hover { color: var(--color-danger); }

        .modal-body { padding: 20px; }
        
        textarea.ai-prompt-box {
            width: 100%; height: 120px; background: #050505; border: 1px solid #333;
            color: var(--color-accent); font-family: var(--font-ui); font-size: 14px;
            padding: 15px; resize: none; border-radius: 4px; margin-bottom: 20px;
        }
        textarea.ai-prompt-box:focus { border-color: var(--color-secondary); }

        .ai-log-area {
            font-family: var(--font-mono); font-size: 10px; color: #666;
            margin-top: 10px; height: 30px;
        }

        /* FLOATING KNOB WINDOW */
        .plugin-window {
            position: absolute; width: 250px; background: rgba(18, 18, 22, 0.95);
            border: 1px solid #444; border-top: 2px solid var(--color-accent);
            border-radius: 4px; box-shadow: 0 20px 60px #000;
            display: none; z-index: 3000;
        }
        
        .knob-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        
        .knob-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .knob-svg { width: 50px; height: 50px; cursor: ns-resize; }
        .knob-label { font-size: 9px; color: #888; font-weight: bold; }

        @keyframes slideIn { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <div id="boot-layer">
        <div class="boot-logo">R0Y<span>PAD</span></div>
        <div style="font-family:'Rajdhani'; letter-spacing:8px; font-size:12px; color:#555; margin-top:10px;">SYSTEM 8.0 MONOLITH ARCHITECTURE</div>
        
        <div class="boot-terminal" id="term-log"></div>
        <div class="boot-progress"><div class="boot-bar" id="prog-bar"></div></div>
        
        <button class="btn-start" id="sys-start-btn" onclick="System.initialize()">SİSTEMİ BAŞLAT</button>
    </div>

    <div class="modal-overlay" id="ai-modal">
        <div class="modal-window">
            <div class="modal-header">
                <div class="modal-title">R0Y-AI <span style="color:var(--color-secondary)">MİMAR</span></div>
                <div class="modal-close" onclick="UIManager.closeAI()">×</div>
            </div>
            <div class="modal-body">
                <p style="color:#888; font-size:12px; margin-bottom:10px;">Müzikal vizyonunuzu tanımlayın (Örn: "Hızlı, agresif techno" veya "Yavaş, duygusal trap"). AI, gam ve ritim teorisi kullanarak parçayı oluşturacaktır.</p>
                <textarea class="ai-prompt-box" id="ai-input" placeholder="Prompt giriniz..."></textarea>
                <button class="ai-generate-btn" style="width:100%; justify-content:center;" onclick="AI.generate()">OLUŞTUR (GENERATE)</button>
                <div class="ai-log-area" id="ai-status">Sistem Hazır.</div>
            </div>
        </div>
    </div>

    <div id="plugin-layer"></div>

    <header>
        <div class="brand-area">
            <div class="app-title">R0YPAD</div>
            <div class="app-ver">v8.0</div>
        </div>

        <button class="ai-generate-btn" onclick="UIManager.openAI()">
            <span>✧</span> AI OLUŞTURUCU
        </button>

        <div class="controls-area">
            <div class="display-lcd">
                <div class="lcd-label">BPM</div>
                <input class="lcd-value" type="number" id="bpm-val" value="140" onchange="AudioEngine.setBpm(this.value)" style="background:none; border:none; width:50px;">
            </div>
            <div class="transport-btn btn-stop" onclick="AudioEngine.stop()">■</div>
            <div class="transport-btn btn-play" id="play-btn" onclick="AudioEngine.toggle()">▶</div>
            <div class="transport-btn" style="width:auto; padding:0 10px; font-size:10px;" onclick="AudioEngine.clear()">TEMİZLE</div>
        </div>
    </header>

    <div id="workspace">
        <div class="track-container" id="track-list">
            </div>
    </div>

    <div id="mixer">
        <div class="channel-strip master-channel">
            <div class="strip-header" style="color:var(--color-secondary)">MASTER</div>
            <div class="fx-slot active" title="Safety Limiter Active">LIMITER</div>
            <div class="fx-slot active" title="Master Compressor">COMP</div>
            
            <div class="fader-track">
                <div class="vu-meter"><div class="vu-fill" id="vu-master"></div></div>
                <input type="range" class="vertical-fader" min="0" max="1.2" step="0.01" value="0.9" oninput="AudioEngine.setMasterVol(this.value)">
            </div>
        </div>
    </div>

<script>
    /**
     * ======================================================================================
     * R0YPAD STUDIO v8.0 - MONOLITH ENGINE
     * ======================================================================================
     * Mimari:
     * 1. Logger: Sistem kayıtlarını tutar.
     * 2. Store: Global state (trackler, fx ayarları) yönetim merkezi.
     * 3. AudioEngine: WebAudio API wrapper, Scheduler, DSP (Sinyal İşleme).
     * 4. Synthesizer: Osilatör ve Envelope mantığı.
     * 5. AI: Müzik teorisi (Scale/Chord) tabanlı üretim.
     * 6. UIManager: DOM manipülasyonu.
     * ======================================================================================
     */

    // --- 1. SYSTEM LOGGER ---
    const Logger = {
        log: (msg, type = 'info') => {
            const term = document.getElementById('term-log');
            if(term) {
                const line = document.createElement('div');
                line.className = `boot-line ${type}`;
                line.innerText = `> ${msg}`;
                term.appendChild(line);
                term.scrollTop = term.scrollHeight;
            }
            console.log(`[SYS-${type.toUpperCase()}] ${msg}`);
        }
    };

    // --- 2. HELPERS ---
    const Utils = {
        id: () => 'id_' + Math.random().toString(36).substr(2, 9),
        wait: (ms) => new Promise(r => setTimeout(r, ms)),
        clamp: (v, min, max) => Math.min(Math.max(v, min), max),
        // Distortion Curve Generator
        makeDistortionCurve: (amount) => {
            const k = typeof amount === 'number' ? amount : 50;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }
    };

    // --- 3. GLOBAL STATE STORE ---
    const Store = {
        tracks: [],
        addTrack: (track) => {
            Store.tracks.push(track);
            UIManager.renderTrack(track);
            UIManager.renderMixerChannel(track);
        },
        removeTrack: (id) => {
            const idx = Store.tracks.findIndex(t => t.id === id);
            if(idx > -1) {
                Store.tracks[idx].cleanup(); // Audio node'ları temizle
                Store.tracks.splice(idx, 1);
                UIManager.removeTrackUI(id);
            }
        },
        clearAll: () => {
            // Ters döngü ile sil ki index kaymasın
            for(let i = Store.tracks.length - 1; i >= 0; i--) {
                Store.removeTrack(Store.tracks[i].id);
            }
        }
    };

    // --- 4. AUDIO ENGINE (DSP CORE) ---
    const AudioEngine = {
        ctx: null,
        masterGain: null,
        limiter: null,
        analyser: null,
        isPlaying: false,
        tempo: 140,
        currentStep: 0,
        nextNoteTime: 0.0,
        timerID: null,
        lookahead: 25.0,
        scheduleAheadTime: 0.1,

        // Başlatma (Singleton)
        init: () => {
            if (AudioEngine.ctx) return;
            const AudioCtor = window.AudioContext || window.webkitAudioContext;
            AudioEngine.ctx = new AudioCtor({ latencyHint: 'interactive' });
            
            // Master Bus Zinciri: MasterGain -> Limiter -> Analyser -> Dest
            AudioEngine.masterGain = AudioEngine.ctx.createGain();
            AudioEngine.masterGain.gain.value = 0.9;

            // Safety Limiter (Ses patlamalarını önler)
            AudioEngine.limiter = AudioEngine.ctx.createDynamicsCompressor();
            AudioEngine.limiter.threshold.value = -1.0;
            AudioEngine.limiter.knee.value = 0.0;
            AudioEngine.limiter.ratio.value = 20.0;
            AudioEngine.limiter.attack.value = 0.005;
            AudioEngine.limiter.release.value = 0.1;

            AudioEngine.analyser = AudioEngine.ctx.createAnalyser();
            AudioEngine.analyser.fftSize = 256;

            AudioEngine.masterGain.connect(AudioEngine.limiter);
            AudioEngine.limiter.connect(AudioEngine.analyser);
            AudioEngine.analyser.connect(AudioEngine.ctx.destination);

            Logger.log("Audio Context Created @ " + AudioEngine.ctx.sampleRate + "Hz");
            
            // VU Meter Loop
            AudioEngine.meterLoop();
        },

        toggle: () => {
            if(!AudioEngine.ctx) AudioEngine.init();
            if(AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();

            AudioEngine.isPlaying = !AudioEngine.isPlaying;
            
            const btn = document.getElementById('play-btn');
            if(AudioEngine.isPlaying) {
                btn.classList.add('playing');
                btn.innerText = "||";
                AudioEngine.currentStep = 0;
                AudioEngine.nextNoteTime = AudioEngine.ctx.currentTime + 0.1;
                AudioEngine.scheduler();
            } else {
                btn.classList.remove('playing');
                btn.innerText = "▶";
                clearTimeout(AudioEngine.timerID);
            }
        },

        stop: () => {
            AudioEngine.isPlaying = false;
            clearTimeout(AudioEngine.timerID);
            AudioEngine.currentStep = 0;
            document.getElementById('play-btn').classList.remove('playing');
            document.getElementById('play-btn').innerText = "▶";
            UIManager.resetPlayhead();
        },

        scheduler: () => {
            while (AudioEngine.nextNoteTime < AudioEngine.ctx.currentTime + AudioEngine.scheduleAheadTime) {
                AudioEngine.scheduleNote(AudioEngine.currentStep, AudioEngine.nextNoteTime);
                AudioEngine.advanceNote();
            }
            AudioEngine.timerID = setTimeout(AudioEngine.scheduler, AudioEngine.lookahead);
        },

        advanceNote: () => {
            const secondsPerBeat = 60.0 / AudioEngine.tempo;
            AudioEngine.nextNoteTime += 0.25 * secondsPerBeat; // 16th note resolution
            AudioEngine.currentStep = (AudioEngine.currentStep + 1) % 16;
        },

        scheduleNote: (stepNumber, time) => {
            // UI Update (requestAnimationFrame ile senkronize değil, time based)
            const drawTime = (time - AudioEngine.ctx.currentTime) * 1000;
            setTimeout(() => {
                UIManager.movePlayhead(stepNumber);
            }, Math.max(0, drawTime));

            // Trigger Tracks
            Store.tracks.forEach(track => {
                if (track.steps[stepNumber] && !track.muted) {
                    track.voice.trigger(time);
                    // Kanal Metering Simülasyonu
                    setTimeout(() => UIManager.pulseMeter(track.id), Math.max(0, drawTime));
                }
            });
        },

        setBpm: (val) => { AudioEngine.tempo = Utils.clamp(parseInt(val), 40, 300); },
        setMasterVol: (val) => { if(AudioEngine.masterGain) AudioEngine.masterGain.gain.value = val; },
        
        clear: () => {
            Store.tracks.forEach(t => t.steps.fill(false));
            document.querySelectorAll('.step-btn.active').forEach(e => e.classList.remove('active'));
        },

        meterLoop: () => {
            // Basit VU Meter görselleştirmesi (Analyser datasına göre)
            if(AudioEngine.isPlaying) {
                const array = new Uint8Array(AudioEngine.analyser.frequencyBinCount);
                AudioEngine.analyser.getByteFrequencyData(array);
                let sum = 0;
                for(let i=0; i<array.length; i++) sum += array[i];
                const avg = sum / array.length;
                const h = Math.min(100, (avg / 255) * 150); // Scale factor
                document.getElementById('vu-master').style.height = h + "%";
            } else {
                document.getElementById('vu-master').style.height = "0%";
            }
            requestAnimationFrame(AudioEngine.meterLoop);
        }
    };

    // --- 5. SYNTHESIZER & TRACK CLASS ---
    class Track {
        constructor(name, type, params = {}) {
            this.id = Utils.id();
            this.name = name;
            this.type = type; // 'kick', 'snare', 'hat', 'synth'
            this.params = params;
            this.steps = new Array(16).fill(false);
            this.muted = false;
            
            // FX State
            this.fx = {
                vol: 0.8,
                dist: 0,
                delayTime: 0,
                delayFb: 0
            };

            // Audio Graph Kurulumu
            this.gainNode = AudioEngine.ctx.createGain();
            this.gainNode.gain.value = 0.8;
            
            // Efekt Zinciri: Source -> Dist -> Delay -> Gain -> Master
            this.distNode = AudioEngine.ctx.createWaveShaper();
            this.distNode.curve = Utils.makeDistortionCurve(0);
            this.distNode.oversample = '4x';

            this.delayNode = AudioEngine.ctx.createDelay();
            this.delayNode.delayTime.value = 0;
            this.delayFbNode = AudioEngine.ctx.createGain();
            this.delayFbNode.gain.value = 0;
            this.delayNode.connect(this.delayFbNode);
            this.delayFbNode.connect(this.delayNode);

            // Bağlantılar
            this.distNode.connect(this.delayNode);
            this.distNode.connect(this.gainNode); // Dry Signal
            this.delayNode.connect(this.gainNode); // Wet Signal
            this.gainNode.connect(AudioEngine.masterGain);

            // Ses Motorunu Başlat
            this.voice = new VoiceEngine(this);
        }

        cleanup() {
            this.gainNode.disconnect();
            this.distNode.disconnect();
            this.delayNode.disconnect();
        }

        updateFX(type, val) {
            if(type === 'VOL') {
                this.gainNode.gain.value = val;
                this.fx.vol = val;
            } else if (type === 'DIST') {
                this.fx.dist = val;
                this.distNode.curve = Utils.makeDistortionCurve(val);
            } else if (type === 'D_TIME') {
                this.fx.delayTime = val;
                this.delayNode.delayTime.value = (val / 100) * 0.5; // Max 0.5s
            } else if (type === 'D_FB') {
                this.fx.delayFb = val;
                this.delayFbNode.gain.value = (val / 100) * 0.9;
            }
        }
    }

    class VoiceEngine {
        constructor(track) {
            this.track = track;
            this.ctx = AudioEngine.ctx;
        }

        trigger(time) {
            // Source Giriş Noktası: this.track.distNode
            const dest = this.track.distNode;
            
            // 1. KICK DRUM
            if (this.track.type === 'kick') {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(this.track.params.freq || 150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                osc.connect(gain); gain.connect(dest);
                osc.start(time); osc.stop(time + 0.5);
            }
            // 2. SNARE
            else if (this.track.type === 'snare') {
                // Tone
                const osc = this.ctx.createOscillator();
                osc.type = 'triangle';
                const oscGain = this.ctx.createGain();
                osc.connect(oscGain); oscGain.connect(dest);
                osc.frequency.setValueAtTime(200, time);
                oscGain.gain.setValueAtTime(0.5, time);
                oscGain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
                osc.start(time); osc.stop(time + 0.1);
                
                // Noise
                const noiseBuf = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.2, this.ctx.sampleRate);
                const output = noiseBuf.getChannelData(0);
                for (let i = 0; i < output.length; i++) output[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = noiseBuf;
                const noiseFil = this.ctx.createBiquadFilter();
                noiseFil.type = 'highpass'; noiseFil.frequency.value = 1000;
                const noiseGain = this.ctx.createGain();
                noise.connect(noiseFil); noiseFil.connect(noiseGain); noiseGain.connect(dest);
                noiseGain.gain.setValueAtTime(0.8, time);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
                noise.start(time);
            }
            // 3. HI-HAT
            else if (this.track.type === 'hat') {
                const ratios = [2, 3, 4.16, 5.43, 6.79, 8.21];
                const bandpass = this.ctx.createBiquadFilter();
                bandpass.type = 'bandpass'; bandpass.frequency.value = 10000;
                bandpass.connect(dest);
                ratios.forEach(ratio => {
                    const osc = this.ctx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.value = 40 * ratio;
                    osc.connect(bandpass);
                    osc.start(time); osc.stop(time + 0.05);
                });
            }
            // 4. SYNTH (MELODY)
            else {
                const osc = this.ctx.createOscillator();
                osc.type = this.track.params.wave || 'sawtooth';
                osc.frequency.value = this.track.params.freq || 440;
                
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(this.track.params.cutoff || 1000, time);
                filter.frequency.linearRampToValueAtTime(100, time + 0.3);

                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.5, time + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.4);

                osc.connect(filter); filter.connect(gain); gain.connect(dest);
                osc.start(time); osc.stop(time + 0.4);
            }
        }
    }

    // --- 6. AI & MUSIC THEORY ENGINE ---
    const AI = {
        scales: {
            'minor': [0, 2, 3, 5, 7, 8, 10], // C Minor
            'major': [0, 2, 4, 5, 7, 9, 11], // C Major
            'phrygian': [0, 1, 3, 5, 7, 8, 10] // Dark/Trap
        },
        rootFreq: 261.63, // C4

        generate: async () => {
            const prompt = document.getElementById('ai-input').value.toLowerCase();
            const status = document.getElementById('ai-status');
            
            if(!prompt) { status.innerText = "Hata: Prompt boş olamaz."; return; }
            status.style.color = "var(--color-warning)";
            status.innerText = "Analiz ediliyor...";
            await Utils.wait(500);

            // 1. Parametre Analizi
            let bpm = 130;
            let mood = 'minor';
            let genre = 'trap';

            if(prompt.includes('hızlı') || prompt.includes('techno')) bpm = 140;
            if(prompt.includes('yavaş') || prompt.includes('lofi')) bpm = 85;
            if(prompt.includes('drill')) { bpm = 145; genre = 'drill'; mood = 'phrygian'; }
            if(prompt.includes('mutlu')) mood = 'major';
            if(prompt.includes('karanlık') || prompt.includes('sert')) mood = 'phrygian';

            // 2. Proje Temizleme
            status.innerText = `Tespit: ${bpm} BPM | ${mood.toUpperCase()} | ${genre.toUpperCase()}`;
            Store.clearAll();
            AudioEngine.setBpm(bpm);
            document.getElementById('bpm-val').value = bpm;
            await Utils.wait(500);

            // 3. Track Oluşturma
            const scale = AI.scales[mood];
            
            // KICK
            const kick = new Track('AI KICK', 'kick', { freq: 50 });
            Store.addTrack(kick);
            AI.fillPattern(kick, 'kick', genre);
            
            // SNARE
            const snare = new Track('AI SNARE', 'snare', {});
            Store.addTrack(snare);
            AI.fillPattern(snare, 'snare', genre);

            // HI-HATS
            const hat = new Track('AI HATS', 'hat', {});
            Store.addTrack(hat);
            AI.fillPattern(hat, 'hat', genre);

            // MELODY (BASS/LEAD)
            const noteIndex = scale[Math.floor(Math.random() * scale.length)];
            const freq = AI.rootFreq * Math.pow(2, noteIndex / 12);
            
            const synth = new Track('AI SYNTH', 'synth', { 
                freq: freq, 
                wave: mood === 'major' ? 'sine' : 'sawtooth',
                cutoff: genre === 'techno' ? 800 : 2000 
            });
            // FX for synth
            if(mood === 'phrygian') { synth.updateFX('DIST', 30); synth.updateFX('D_TIME', 40); synth.updateFX('D_FB', 40); }
            Store.addTrack(synth);
            AI.fillPattern(synth, 'melody', genre);

            status.style.color = "var(--color-success)";
            status.innerText = "Oluşturma Başarılı. Panel Kapatılıyor...";
            await Utils.wait(1000);
            UIManager.closeAI();
            AudioEngine.toggle(); // Otomatik oynat
        },

        fillPattern: (track, type, genre) => {
            const steps = track.steps;
            for(let i=0; i<16; i++) {
                let hit = false;
                
                if(type === 'kick') {
                    if(i === 0) hit = true;
                    if(genre === 'techno' && i % 4 === 0) hit = true;
                    if(genre === 'trap' && (i === 0 || i === 10 || i === 14)) hit = (Math.random() > 0.3);
                }
                else if(type === 'snare') {
                    if((genre === 'trap' || genre === 'drill') && i === 8) hit = true; // 3rd beat
                    if(genre === 'techno' && (i === 4 || i === 12)) hit = true;
                }
                else if(type === 'hat') {
                    if(i % 2 === 0) hit = true; // 8th notes
                    if(genre === 'trap' && Math.random() > 0.8) hit = true; // Rolls
                }
                else if(type === 'melody') {
                    if(genre === 'techno' && i % 2 !== 0) hit = true; // Offbeat bass
                    if(genre !== 'techno' && Math.random() > 0.7 && i % 2 === 0) hit = true;
                }

                if(hit) {
                    track.steps[i] = true;
                    // UI Update simulating typing
                    setTimeout(() => {
                        const btn = document.querySelector(`#step-${track.id}-${i}`);
                        if(btn) btn.classList.add('active');
                    }, i * 50);
                }
            }
        }
    };

    // --- 7. UI MANAGER ---
    const UIManager = {
        renderTrack: (track) => {
            const container = document.getElementById('track-list');
            const row = document.createElement('div');
            row.className = 'track-row';
            row.id = `row-${track.id}`;
            row.innerHTML = `
                <div class="track-header">
                    <div class="th-name">${track.name}</div>
                    <div class="th-type">${track.type}</div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <div class="fx-slot" onclick="UIManager.toggleMute('${track.id}', this)">MUTE</div>
                        <div class="fx-slot" style="color:var(--color-danger)" onclick="Store.removeTrack('${track.id}')">X</div>
                    </div>
                </div>
                <div class="step-sequencer">
                    ${track.steps.map((_, i) => 
                        `<div class="step-btn" id="step-${track.id}-${i}" onclick="UIManager.toggleStep('${track.id}', ${i}, this)"></div>`
                    ).join('')}
                </div>
            `;
            container.appendChild(row);
        },

        renderMixerChannel: (track) => {
            const mixer = document.getElementById('mixer');
            const master = document.querySelector('.master-channel');
            
            const strip = document.createElement('div');
            strip.className = 'channel-strip';
            strip.id = `strip-${track.id}`;
            strip.innerHTML = `
                <div class="strip-header">${track.name.substr(0, 8)}</div>
                <div class="fx-slot" onclick="UIManager.openPlugin('${track.id}', 'DIST')">DIST</div>
                <div class="fx-slot" onclick="UIManager.openPlugin('${track.id}', 'DELAY')">DELAY</div>
                <div class="fader-track">
                    <div class="vu-meter"><div class="vu-fill" id="vu-${track.id}"></div></div>
                    <input type="range" class="vertical-fader" min="0" max="1" step="0.01" value="0.8" 
                        oninput="Store.tracks.find(t=>t.id=='${track.id}').updateFX('VOL', this.value)">
                </div>
            `;
            mixer.insertBefore(strip, master);
        },

        removeTrackUI: (id) => {
            document.getElementById(`row-${id}`).remove();
            document.getElementById(`strip-${id}`).remove();
            // Close plugin window if open
            const win = document.getElementById(`plugin-${id}`);
            if(win) win.remove();
        },

        toggleStep: (tid, idx, el) => {
            const track = Store.tracks.find(t => t.id === tid);
            if(track) {
                track.steps[idx] = !track.steps[idx];
                el.classList.toggle('active');
            }
        },

        toggleMute: (tid, el) => {
            const track = Store.tracks.find(t => t.id === tid);
            if(track) {
                track.muted = !track.muted;
                el.style.color = track.muted ? 'var(--color-danger)' : '#555';
            }
        },

        movePlayhead: (step) => {
            document.querySelectorAll('.step-btn.playhead').forEach(e => e.classList.remove('playhead'));
            // CSS selector ile performanslı seçim (nth-child 1-based index)
            document.querySelectorAll(`.step-btn:nth-child(${step + 1})`).forEach(e => e.classList.add('playhead'));
        },

        resetPlayhead: () => {
            document.querySelectorAll('.step-btn.playhead').forEach(e => e.classList.remove('playhead'));
        },

        pulseMeter: (tid) => {
            const el = document.getElementById(`vu-${tid}`);
            if(el) {
                el.style.height = (Math.random() * 50 + 40) + "%";
                setTimeout(() => el.style.height = "0%", 100);
            }
        },

        openAI: () => { document.getElementById('ai-modal').style.display = 'flex'; },
        closeAI: () => { document.getElementById('ai-modal').style.display = 'none'; },

        // --- PLUGIN WINDOW LOGIC ---
        openPlugin: (tid, type) => {
            const pid = `plugin-${tid}`;
            const existing = document.getElementById(pid);
            if(existing) existing.remove(); // Tek pencere mantığı (opsiyonel)

            const track = Store.tracks.find(t => t.id === tid);
            if(!track) return;

            const win = document.createElement('div');
            win.className = 'plugin-window';
            win.id = pid;
            
            // Random pozisyon (Stacklenmesin)
            win.style.top = (200 + Math.random() * 50) + 'px';
            win.style.left = (300 + Math.random() * 100) + 'px';

            let knobsHTML = '';
            if(type === 'DIST') {
                knobsHTML = UIManager.createKnobHTML(tid, 'DIST', 'DRIVE', track.fx.dist, 0, 100);
            } else if (type === 'DELAY') {
                knobsHTML = UIManager.createKnobHTML(tid, 'D_TIME', 'TIME', track.fx.delayTime, 0, 100) +
                            UIManager.createKnobHTML(tid, 'D_FB', 'FDBK', track.fx.delayFb, 0, 100);
            }

            win.innerHTML = `
                <div style="padding:10px; background:#222; display:flex; justify-content:space-between; cursor:move;" 
                     onmousedown="UIManager.dragElement(event, '${pid}')">
                    <span style="font-size:10px; font-weight:bold; color:#fff;">${track.name} - ${type}</span>
                    <span style="cursor:pointer; color:red;" onclick="this.parentElement.parentElement.remove()">x</span>
                </div>
                <div class="knob-grid">${knobsHTML}</div>
            `;
            document.getElementById('plugin-layer').appendChild(win);
        },

        createKnobHTML: (tid, paramType, label, val, min, max) => {
            // SVG Knob çizimi yerine basit slider kullanıyoruz ama CSS ile Knob gibi gösterebiliriz
            // Risksiz kod için standart range input kullanıp style ile özelleştirdim.
            return `
                <div class="knob-wrapper">
                    <input type="range" min="${min}" max="${max}" value="${val}" style="width:100%"
                        oninput="Store.tracks.find(t=>t.id=='${tid}').updateFX('${paramType}', this.value)">
                    <div class="knob-label">${label}</div>
                </div>
            `;
        },

        dragElement: (e, id) => {
            const el = document.getElementById(id);
            let shiftX = e.clientX - el.getBoundingClientRect().left;
            let shiftY = e.clientY - el.getBoundingClientRect().top;
            
            const moveAt = (pageX, pageY) => {
                el.style.left = pageX - shiftX + 'px';
                el.style.top = pageY - shiftY + 'px';
            };
            
            const onMouseMove = (ev) => moveAt(ev.pageX, ev.pageY);
            
            document.addEventListener('mousemove', onMouseMove);
            document.onmouseup = () => {
                document.removeEventListener('mousemove', onMouseMove);
                document.onmouseup = null;
            };
        }
    };

    // --- 8. SYSTEM BOOTSTRAP ---
    const System = {
        initialize: () => {
            // Animasyonlu geçiş
            const layer = document.getElementById('boot-layer');
            layer.style.opacity = 0;
            setTimeout(() => {
                layer.style.display = 'none';
                AudioEngine.init();
            }, 1000);
        },
        bootSequence: async () => {
            const logs = [
                "BIOS CHECK... OK",
                "LOADING MEMORY MODULES...",
                "INITIALIZING DSP ENGINE...",
                "CHECKING AUDIO DRIVERS...",
                "CONNECTING TO R0Y-CORE AI...",
                "LOADING PRESETS (TRAP, DRILL, TECHNO)...",
                "SYSTEM READY."
            ];
            
            const bar = document.getElementById('prog-bar');
            
            for(let i=0; i<logs.length; i++) {
                Logger.log(logs[i]);
                bar.style.width = ((i+1) / logs.length * 100) + "%";
                await Utils.wait(600);
            }
            
            document.getElementById('sys-start-btn').style.display = 'block';
        }
    };

    // --- AUTO START ---
    window.onload = System.bootSequence;

</script>
</body>
</html>
