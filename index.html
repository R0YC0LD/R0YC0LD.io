<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R0YPAD STUDIO | ARCHITECT AI EDITION v7.0</title>
    <meta name="description" content="AI Powered Professional Web Audio Sequencer">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@300;500;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ==========================================================================
         * CORE VARIABLES
         * ==========================================================================
         */
        :root {
            --bg-deep: #030303;
            --bg-dark: #09090b;
            --bg-surface: #121215;
            --accent-primary: #00f3ff; /* Cyber Cyan */
            --accent-secondary: #7000ff; /* Electric Purple */
            --accent-glow: rgba(0, 243, 255, 0.4);
            --danger: #ff0055;
            --success: #00ff9d;
            --warning: #ffbf00;
            --text-main: #ffffff;
            --text-dim: #666;
            --glass-bg: rgba(18, 18, 21, 0.95);
            --header-height: 70px;
            --mixer-height: 340px;
        }

        /* * ==========================================================================
         * GLOBAL & RESET
         * ==========================================================================
         */
        * { box-sizing: border-box; user-select: none; outline: none; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-primary); }

        body {
            margin: 0; padding: 0;
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: grid;
            grid-template-rows: var(--header-height) 1fr var(--mixer-height);
        }

        /* * ==========================================================================
         * VISUALIZER (SPECTRUM)
         * ==========================================================================
         */
        #spectrumCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 200px;
            z-index: 50;
            pointer-events: none;
            opacity: 0.6;
            mix-blend-mode: screen;
            display: none; /* Toggled by user */
        }
        
        .visualizer-overlay {
            position: fixed;
            top: 60px; right: 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--accent-primary);
            padding: 10px;
            z-index: 900;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono';
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* * ==========================================================================
         * LOADING SCREEN
         * ==========================================================================
         */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'JetBrains Mono';
        }

        .loader-glitch {
            font-size: 6rem; font-weight: 800; color: #fff;
            text-shadow: 2px 2px var(--danger), -2px -2px var(--accent-primary);
            animation: glitch 1s infinite alternate;
            letter-spacing: -5px;
        }

        @keyframes glitch {
            0% { transform: skew(0deg); }
            20% { transform: skew(-2deg); }
            40% { transform: skew(2deg); }
            100% { transform: skew(0deg); }
        }

        .log-container {
            width: 600px; height: 150px;
            background: #050505; border: 1px solid #222;
            margin-top: 30px; padding: 15px;
            overflow: hidden; font-size: 11px;
            color: var(--success); text-align: left;
            box-shadow: 0 0 20px rgba(0,255,157,0.1);
        }

        .start-btn {
            margin-top: 30px; padding: 20px 60px;
            background: transparent; border: 2px solid var(--accent-primary);
            color: var(--accent-primary); font-size: 18px; font-weight: 900;
            cursor: pointer; letter-spacing: 2px;
            transition: 0.3s; display: none;
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .start-btn:hover { background: var(--accent-primary); color: #000; }

        /* * ==========================================================================
         * HEADER & TOOLBAR
         * ==========================================================================
         */
        header {
            background: var(--bg-surface);
            border-bottom: 1px solid #222;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 100;
        }

        .brand { font-family: 'Rajdhani'; font-size: 28px; font-weight: 700; letter-spacing: 1px; }
        .brand span { color: var(--accent-primary); }
        
        .ai-btn {
            background: linear-gradient(45deg, #7000ff, #00f3ff);
            border: none; color: #fff;
            padding: 8px 20px; border-radius: 4px;
            font-weight: 800; font-size: 12px;
            cursor: pointer; box-shadow: 0 0 20px rgba(112,0,255,0.5);
            animation: glowPulse 2s infinite;
            display: flex; align-items: center; gap: 8px;
        }
        
        @keyframes glowPulse { 0% { opacity: 0.9; } 50% { opacity: 1; box-shadow: 0 0 30px rgba(0,243,255,0.6); } 100% { opacity: 0.9; } }

        .toolbar { display: flex; gap: 10px; align-items: center; background: #080808; padding: 5px 15px; border-radius: 6px; border: 1px solid #222; }
        
        .ctrl-btn {
            background: #18181b; color: #ccc; border: 1px solid #333;
            padding: 6px 12px; font-size: 11px; font-weight: 700;
            border-radius: 3px; cursor: pointer; transition: 0.2s;
        }
        .ctrl-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .ctrl-btn.active-play { background: var(--warning); color: #000; border-color: var(--warning); }
        .ctrl-btn.stop { color: var(--danger); border-color: #522; }

        input[type=number] { background: transparent; border: none; color: var(--accent-primary); width: 40px; text-align: center; font-weight: bold; }

        /* * ==========================================================================
         * WORKSPACE & TRACKS
         * ==========================================================================
         */
        .workspace { background: #050505; position: relative; display: flex; overflow: hidden; }
        .workspace::before {
            content: ''; position: absolute; width: 100%; height: 100%;
            background-image: linear-gradient(#111 1px, transparent 1px), linear-gradient(90deg, #111 1px, transparent 1px);
            background-size: 50px 50px; opacity: 0.3; pointer-events: none;
        }
        
        .seq-container { flex: 1; padding: 20px; overflow-y: auto; z-index: 10; }
        
        .track {
            display: flex; height: 50px; margin-bottom: 6px;
            background: rgba(255,255,255,0.02); border-left: 2px solid transparent;
            transition: 0.2s;
        }
        .track:hover { background: rgba(255,255,255,0.04); }
        
        .track-info {
            width: 160px; padding: 0 15px; display: flex; flex-direction: column; justify-content: center;
            border-right: 1px solid #222; position: relative;
        }
        .t-title { font-size: 12px; font-weight: 700; color: #fff; }
        .t-meta { font-size: 9px; color: var(--accent-primary); opacity: 0.7; margin-top: 2px; text-transform: uppercase; }
        
        .step-grid { flex: 1; display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; padding: 5px; }
        .step {
            background: #111; border-radius: 2px; cursor: pointer;
            border: 1px solid transparent; transition: 0.1s;
        }
        .step:nth-child(4n+1) { background: #1a1a1a; }
        .step:hover { border-color: #333; }
        .step.active { background: var(--accent-primary); box-shadow: 0 0 8px var(--accent-glow); }
        .step.playhead { background: #fff !important; transform: scale(1.1); z-index: 5; }

        /* * ==========================================================================
         * MIXER
         * ==========================================================================
         */
        .mixer {
            background: #0a0a0c; border-top: 1px solid #222;
            display: flex; padding: 15px; gap: 8px; overflow-x: auto;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }
        
        .strip {
            width: 90px; height: 100%; background: #131316;
            border: 1px solid #222; border-radius: 4px;
            display: flex; flex-direction: column; padding: 8px;
            flex-shrink: 0; position: relative;
        }
        .strip.master { border: 1px solid var(--accent-secondary); background: #0f0b1a; margin-left: auto; width: 110px; }
        
        .fx-slot {
            font-size: 9px; background: #000; color: #555;
            padding: 3px; margin-bottom: 2px; text-align: center;
            cursor: pointer; border: 1px solid #1a1a1a; transition: 0.2s;
        }
        .fx-slot:hover { color: #fff; border-color: #444; }
        .fx-slot.active { color: var(--accent-primary); border-color: var(--accent-primary); background: rgba(0,243,255,0.1); }
        
        /* Faders */
        .fader-area { flex: 1; position: relative; display: flex; justify-content: center; margin-top: 10px; }
        input[type=range].vol {
            -webkit-appearance: none; width: 140px; height: 20px;
            background: transparent; transform: rotate(-90deg);
            margin-top: 60px; cursor: ns-resize;
        }
        input[type=range].vol::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 24px;
            background: #444; border: 1px solid #000; border-radius: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
        }
        .strip.master input[type=range].vol::-webkit-slider-thumb { background: var(--accent-secondary); }

        /* * ==========================================================================
         * AI MODAL
         * ==========================================================================
         */
        .ai-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        
        .ai-window {
            width: 600px; background: #111; border: 1px solid var(--accent-secondary);
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 0 50px rgba(112,0,255,0.3);
            display: flex; flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .ai-header { padding: 15px; background: linear-gradient(90deg, #222, #111); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .ai-title { font-family: 'Rajdhani'; font-weight: 700; color: #fff; font-size: 20px; }
        .ai-title span { color: var(--accent-secondary); }
        
        .ai-body { padding: 25px; }
        textarea.ai-input {
            width: 100%; height: 100px; background: #050505; border: 1px solid #333;
            color: var(--accent-primary); font-family: 'Inter'; font-size: 14px;
            padding: 10px; resize: none; border-radius: 6px; margin-bottom: 20px;
        }
        textarea.ai-input:focus { border-color: var(--accent-secondary); box-shadow: 0 0 10px rgba(112,0,255,0.2); }
        
        .ai-action-btn {
            width: 100%; padding: 15px; background: var(--accent-secondary);
            border: none; color: #fff; font-weight: 800; font-size: 14px;
            cursor: pointer; border-radius: 6px; transition: 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .ai-action-btn:hover { background: #8a2be2; box-shadow: 0 0 20px rgba(138,43,226,0.5); }
        
        .ai-log { font-family: 'JetBrains Mono'; font-size: 10px; color: #888; margin-top: 15px; min-height: 20px; }

        /* * ==========================================================================
         * PLUGIN WINDOWS (EQ, DIST, DELAY)
         * ==========================================================================
         */
        .plugin-win {
            position: absolute; width: 280px; background: var(--glass-bg);
            border: 1px solid #333; border-top: 2px solid var(--accent-primary);
            border-radius: 6px; display: none; z-index: 500;
            box-shadow: 0 20px 50px #000;
        }
        .pw-head { padding: 8px 12px; background: #1a1a1a; cursor: move; font-size: 11px; font-weight: 700; display: flex; justify-content: space-between; }
        .pw-body { padding: 15px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        
        .knob-wrap { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .knob-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background: conic-gradient(var(--accent-primary) var(--deg), #222 0deg);
            position: relative; cursor: ns-resize;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .knob-circle::after { content: ''; position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px; background: #151515; border-radius: 50%; }
        .knob-line { position: absolute; top: 0; left: 50%; height: 50%; width: 2px; background: transparent; transform-origin: bottom center; transform: rotate(var(--rot)); pointer-events: none; z-index: 2; }
        .knob-line::after { content: ''; position: absolute; top: 2px; left: 0; width: 2px; height: 6px; background: #fff; }
        .knob-txt { font-size: 9px; color: #777; font-weight: 700; }

        /* * ==========================================================================
         * LIBRARY
         * ==========================================================================
         */
        .lib-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; padding: 20px; }
        .lib-item { background: #151518; border: 1px solid #222; padding: 10px; cursor: pointer; border-radius: 4px; }
        .lib-item:hover { border-color: var(--accent-primary); background: #1a1a20; }
        
    </style>
</head>
<body>

    <canvas id="spectrumCanvas"></canvas>
    <div class="visualizer-overlay" onclick="Visualizer.toggle()">GÖSTERGE: <span id="visStatus">KAPALI</span> (TIKLA)</div>

    <div id="loader">
        <div class="loader-glitch">R0Y-AI</div>
        <div style="font-size: 14px; letter-spacing: 5px; color: #888; margin-top: 10px;">ARCHITECT EDITION v7.0</div>
        <div class="log-container" id="bootLog"></div>
        <button class="start-btn" id="enterBtn" onclick="System.init()">SİSTEME BAĞLAN</button>
    </div>

    <div class="ai-overlay" id="aiModal">
        <div class="ai-window">
            <div class="ai-header">
                <div class="ai-title">R0Y<span>-AI</span> MİMAR</div>
                <div style="cursor:pointer; color:#555" onclick="document.getElementById('aiModal').style.display='none'">✕</div>
            </div>
            <div class="ai-body">
                <p style="color:#aaa; font-size:12px; margin-bottom:10px;">Nasıl bir parça hayal ediyorsun? (Örn: "Hızlı, karanlık bir drill beat yap" veya "Yavaş duygusal lo-fi")</p>
                <textarea class="ai-input" id="aiPrompt" placeholder="İsteğini buraya yaz..."></textarea>
                <button class="ai-action-btn" onclick="AIEngine.generate()">OLUŞTUR (GENERATE)</button>
                <div class="ai-log" id="aiLog"></div>
            </div>
        </div>
    </div>

    <div id="windowLayer"></div>

    <header>
        <div class="brand">R0Y<span>PAD</span></div>
        
        <button class="ai-btn" onclick="document.getElementById('aiModal').style.display='flex'">
            <span>★</span> YAPAY ZEKA İLE OLUŞTUR
        </button>

        <div class="toolbar">
            <div class="ctrl-btn" style="border:none">BPM</div>
            <input type="number" id="bpmIn" value="140" onchange="AudioCore.setBpm(this.value)">
            <div style="width:1px; height:15px; background:#333; margin:0 5px;"></div>
            <button class="ctrl-btn" onclick="AudioCore.clear()">TEMİZLE</button>
            <button class="ctrl-btn" id="playBtn" onclick="AudioCore.togglePlay()">OYNAT</button>
            <button class="ctrl-btn stop" onclick="AudioCore.stop()">DUR</button>
        </div>
    </header>

    <div class="workspace">
        <div class="seq-container" id="trackContainer">
            </div>
    </div>

    <div class="mixer" id="mixerContainer">
        <div class="strip master">
            <div style="text-align:center; font-size:10px; color:var(--accent-secondary); font-weight:bold; margin-bottom:5px;">MASTER</div>
            <div class="fx-slot active">COMPRESSOR</div>
            <div class="fx-slot active">LIMITER</div>
            <div class="fader-area">
                <input type="range" class="vol" min="0" max="1.2" step="0.01" value="0.9" oninput="AudioCore.masterGain.gain.value=this.value">
            </div>
        </div>
    </div>

<script>
    /**
     * R0YPAD STUDIO v7.0 - THE ARCHITECT
     * * Core Modules:
     * 1. AudioCore: WebAudio Context, Scheduler, Master Bus
     * 2. Track: Instrument synthesis, FX Chain (EQ, Dist, Delay)
     * 3. AIEngine: NLP Parsing, Procedural Generation
     * 4. Visualizer: Canvas frequency analysis
     * 5. UIManager: DOM manipulation, Popups
     */

    // --- 1. UTILITIES ---
    const Utils = {
        id: () => 'id_' + Math.random().toString(36).substr(2, 9),
        rand: (min, max) => Math.random() * (max - min) + min,
        wait: (ms) => new Promise(r => setTimeout(r, ms)),
        distCurve: (amount) => {
            const k = amount; const n = 44100; const curve = new Float32Array(n); const deg = Math.PI / 180;
            for (let i = 0; i < n; ++i) {
                const x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }
    };

    // --- 2. AUDIO CORE ---
    const AudioCore = {
        ctx: null, masterGain: null, analyser: null,
        isPlaying: false, tempo: 140, step: 0, nextTime: 0, timer: null,
        tracks: [],

        init() {
            if (this.ctx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            this.ctx = new AC();
            
            // Master Chain: Gain -> Compressor -> Analyser -> Dest
            this.masterGain = this.ctx.createGain();
            this.masterGain.gain.value = 0.9;

            const comp = this.ctx.createDynamicsCompressor();
            comp.threshold.value = -20; comp.ratio.value = 12;

            this.analyser = this.ctx.createAnalyser();
            this.analyser.fftSize = 256;

            this.masterGain.connect(comp);
            comp.connect(this.analyser);
            this.analyser.connect(this.ctx.destination);
            
            Visualizer.init(); // Start loop
        },

        togglePlay() {
            if (!this.ctx) this.init();
            if (this.ctx.state === 'suspended') this.ctx.resume();
            
            this.isPlaying = !this.isPlaying;
            document.getElementById('playBtn').classList.toggle('active-play', this.isPlaying);
            document.getElementById('playBtn').innerText = this.isPlaying ? "DURAKLAT" : "OYNAT";

            if (this.isPlaying) {
                this.step = 0;
                this.nextTime = this.ctx.currentTime + 0.1;
                this.scheduler();
            } else {
                clearTimeout(this.timer);
            }
        },

        stop() {
            this.isPlaying = false; clearTimeout(this.timer);
            this.step = 0; UIManager.resetHeads();
            document.getElementById('playBtn').classList.remove('active-play');
            document.getElementById('playBtn').innerText = "OYNAT";
        },

        scheduler() {
            while (this.nextTime < this.ctx.currentTime + 0.1) {
                this.playStep(this.step, this.nextTime);
                this.nextTime += 0.25 * (60.0 / this.tempo);
                this.step = (this.step + 1) % 16;
            }
            this.timer = setTimeout(() => this.scheduler(), 25);
        },

        playStep(step, time) {
            // UI Sync
            const drawTime = (time - this.ctx.currentTime) * 1000;
            setTimeout(() => UIManager.highlight(step), Math.max(0, drawTime));

            this.tracks.forEach(t => {
                if (t.steps[step] && !t.muted) t.trigger(time);
            });
        },

        addTrack(cat, name, params = {}) {
            const t = new Track(this.ctx, this.masterGain, cat, name, params);
            this.tracks.push(t);
            UIManager.addTrack(t);
            return t; // Return for AI usage
        },

        clear() {
            this.tracks.forEach(t => t.destroy());
            this.tracks = [];
            document.getElementById('trackContainer').innerHTML = '';
            document.querySelectorAll('.mixer .strip:not(.master)').forEach(e => e.remove());
        },

        setBpm(v) { this.tempo = Math.max(40, Math.min(300, v)); }
    };

    // --- 3. TRACK & DSP ---
    class Track {
        constructor(ctx, dest, cat, name, params) {
            this.ctx = ctx; this.dest = dest; this.cat = cat; this.name = name; this.params = params;
            this.id = Utils.id();
            this.steps = Array(16).fill(false);
            this.muted = false;
            
            // FX State
            this.fx = {
                vol: 0.8,
                eqLow: 0, eqMid: 0, eqHigh: 0,
                dist: 0, delayTime: 0, delayFeed: 0
            };

            // Audio Graph Setup (Lazy Init handled in trigger to save CPU, but chain structure is:)
            // Source -> EQ(Low,Mid,High) -> Dist -> Delay -> Vol -> Master
        }

        trigger(time) {
            // 1. Source
            let src, env;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            if (this.cat === 'kick') {
                osc.frequency.setValueAtTime(this.params.freq || 50, time);
                osc.frequency.exponentialRampToValueAtTime(10, time + 0.5);
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                osc.connect(gain); osc.start(time); osc.stop(time + 0.5);
                src = gain;
            } else if (this.cat === 'snare') {
                // Noise + Tone
                osc.type = 'triangle'; osc.frequency.setValueAtTime(200, time);
                const nBuf = this.ctx.createBuffer(1, 44100 * 0.2, 44100);
                const d = nBuf.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const noise = this.ctx.createBufferSource(); noise.buffer = nBuf;
                const nFil = this.ctx.createBiquadFilter(); nFil.type = 'highpass'; nFil.frequency.value = 1000;
                
                osc.connect(gain); noise.connect(nFil).connect(gain);
                gain.gain.setValueAtTime(0.7, time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                osc.start(time); osc.stop(time + 0.2); noise.start(time);
                src = gain;
            } else if (this.cat === 'hat') {
                // High freq noise
                const nBuf = this.ctx.createBuffer(1, 44100*0.05, 44100);
                const d = nBuf.getChannelData(0); for(let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
                const noise = this.ctx.createBufferSource(); noise.buffer = nBuf;
                const fil = this.ctx.createBiquadFilter(); fil.type='highpass'; fil.frequency.value=6000;
                noise.connect(fil).connect(gain);
                gain.gain.setValueAtTime(0.6, time); gain.gain.exponentialRampToValueAtTime(0.001, time+0.05);
                noise.start(time);
                src = gain;
            } else { // Synth
                osc.type = this.params.wave || 'sawtooth';
                // Simple chord or note
                const freqs = [this.params.freq || 440];
                osc.frequency.value = freqs[0];
                const fil = this.ctx.createBiquadFilter(); fil.type='lowpass'; fil.frequency.setValueAtTime(this.params.cutoff||2000, time);
                fil.frequency.exponentialRampToValueAtTime(100, time + 0.5);
                osc.connect(fil).connect(gain);
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(0.4, time+0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, time+0.6);
                osc.start(time); osc.stop(time+0.6);
                src = gain;
            }

            // 2. FX Chain Construction (On the fly for efficiency)
            
            // EQ
            const low = this.ctx.createBiquadFilter(); low.type='lowshelf'; low.frequency.value=300; low.gain.value=this.fx.eqLow;
            const mid = this.ctx.createBiquadFilter(); mid.type='peaking'; mid.frequency.value=1000; mid.gain.value=this.fx.eqMid;
            const high = this.ctx.createBiquadFilter(); high.type='highshelf'; high.frequency.value=4000; high.gain.value=this.fx.eqHigh;
            
            // Dist
            const dist = this.ctx.createWaveShaper(); 
            if(this.fx.dist > 0) { dist.curve = Utils.distCurve(this.fx.dist); dist.oversample='2x'; }
            
            // Delay (Send style)
            const delay = this.ctx.createDelay(); delay.delayTime.value = this.fx.delayTime * 0.5;
            const feed = this.ctx.createGain(); feed.gain.value = this.fx.delayFeed * 0.8;
            delay.connect(feed).connect(delay);

            // Channel Vol
            const vol = this.ctx.createGain(); vol.gain.value = this.fx.vol;

            // Wiring
            src.connect(low).connect(mid).connect(high).connect(dist);
            dist.connect(vol);
            
            // Delay parallel
            if(this.fx.delayTime > 0) {
                dist.connect(delay).connect(vol);
            }

            vol.connect(this.dest);

            // Cleanup
            setTimeout(() => { vol.disconnect(); }, 2000);
        }

        destroy() { /* Cleanup logic if needed */ }
    }

    // --- 4. AI ENGINE (THE BRAIN) ---
    const AIEngine = {
        async generate() {
            const prompt = document.getElementById('aiPrompt').value.toLowerCase();
            const log = document.getElementById('aiLog');
            
            if(!prompt) { log.innerText = "Lütfen bir şeyler yaz..."; return; }
            log.innerHTML = "PROMPT ANALİZ EDİLİYOR...<br>";
            
            // 1. Parsing Rules
            let bpm = 130;
            let genre = 'trap';
            let mood = 'neutral';
            
            if(prompt.includes('hızlı') || prompt.includes('drill')) bpm = 145;
            else if(prompt.includes('yavaş') || prompt.includes('lo-fi')) bpm = 85;
            else if(prompt.includes('house') || prompt.includes('dans')) bpm = 124;

            if(prompt.includes('karanlık') || prompt.includes('sert')) mood = 'dark';
            if(prompt.includes('mutlu') || prompt.includes('chill')) mood = 'chill';

            // 2. Execution Simulation
            log.innerHTML += `<span style="color:#0ff">>> TESPİT EDİLDİ: BPM ${bpm} | TÜR: ${genre.toUpperCase()} | MOD: ${mood.toUpperCase()}</span><br>`;
            await Utils.wait(600);
            
            log.innerHTML += ">> PROJE TEMİZLENİYOR...<br>";
            AudioCore.clear();
            AudioCore.setBpm(bpm);
            document.getElementById('bpmIn').value = bpm;
            await Utils.wait(500);

            // 3. Step-by-Step Building
            // Add Kick
            log.innerHTML += ">> KICK DRUM TASARLANIYOR...<br>";
            const kick = AudioCore.addTrack('kick', 'AI KICK 808', { freq: mood=='dark'?40:60 });
            await this.fillPattern(kick, genre, 'kick');
            await Utils.wait(800);

            // Add Snare
            log.innerHTML += ">> SNARE/CLAP YERLEŞTİRİLİYOR...<br>";
            const snare = AudioCore.addTrack('snare', 'AI SNARE', {});
            await this.fillPattern(snare, genre, 'snare');
            await Utils.wait(800);

            // Add Hats
            log.innerHTML += ">> HI-HATS RİTMİ YAZILIYOR...<br>";
            const hat = AudioCore.addTrack('hat', 'AI HATS', {});
            await this.fillPattern(hat, genre, 'hat');
            await Utils.wait(800);

            // Add Melody
            log.innerHTML += ">> MELODİ SENTEZLENİYOR...<br>";
            const synth = AudioCore.addTrack('synth', 'AI LEAD', { wave: mood=='dark'?'sawtooth':'sine', cutoff: 1500 });
            await this.fillPattern(synth, genre, 'melody');
            
            // FX Setup
            if(mood === 'dark') {
                kick.fx.dist = 20; 
                synth.fx.delayTime = 40; synth.fx.delayFeed = 50;
            }

            log.innerHTML += "<br><span style='color:#0f0'>✓ OLUŞTURMA TAMAMLANDI.</span>";
            document.getElementById('aiModal').style.display='none';
            AudioCore.togglePlay();
        },

        async fillPattern(track, genre, type) {
            // Algorithmic pattern generation
            const p = track.steps;
            const steps = document.querySelectorAll(`#tr-${track.id} .step`);
            
            for(let i=0; i<16; i++) {
                let active = false;
                
                if (type === 'kick') {
                    if (i===0) active = true;
                    if (genre==='trap' && (i===10 || i===14)) active = Math.random()>0.5;
                    if (genre==='house' && i%4===0) active = true;
                } else if (type === 'snare') {
                    if (genre === 'trap' && i===8) active = true; // 3rd beat
                    if (genre === 'house' && i===4 || i===12) active = true;
                    if (genre === 'drill' && i===8) active = true;
                } else if (type === 'hat') {
                    if (i%2 === 0) active = true; // 8th notes
                    if (Math.random() > 0.8) active = true; // Random rolls
                } else if (type === 'melody') {
                    if (Math.random() > 0.7 && i%2===0) active = true;
                }

                if(active) {
                    track.steps[i] = true;
                    steps[i].classList.add('active');
                    // Simulate typing speed
                    await Utils.wait(30); 
                }
            }
        }
    };

    // --- 5. VISUALIZER ---
    const Visualizer = {
        active: false,
        init() {
            this.cvs = document.getElementById('spectrumCanvas');
            this.ctx = this.cvs.getContext('2d');
            this.resize();
            window.onresize = () => this.resize();
            this.loop();
        },
        resize() {
            this.cvs.width = window.innerWidth;
            this.cvs.height = 200;
        },
        toggle() {
            this.active = !this.active;
            this.cvs.style.display = this.active ? 'block' : 'none';
            document.getElementById('visStatus').innerText = this.active ? "AÇIK" : "KAPALI";
        },
        loop() {
            requestAnimationFrame(() => this.loop());
            if(!this.active || !AudioCore.analyser) return;

            const buffer = new Uint8Array(AudioCore.analyser.frequencyBinCount);
            AudioCore.analyser.getByteFrequencyData(buffer);
            
            const w = this.cvs.width;
            const h = this.cvs.height;
            const barW = (w / buffer.length) * 2.5;
            
            this.ctx.clearRect(0, 0, w, h);
            
            let x = 0;
            for(let i = 0; i < buffer.length; i++) {
                const barH = buffer[i] / 2;
                this.ctx.fillStyle = `rgb(${barH + 100}, 50, 255)`;
                this.ctx.fillRect(x, h - barH, barW, barH);
                x += barW + 1;
            }
        }
    };

    // --- 6. UI MANAGER ---
    const UIManager = {
        addTrack(t) {
            // Sequencer Row
            const div = document.createElement('div');
            div.className = 'track'; div.id = `tr-${t.id}`;
            div.innerHTML = `
                <div class="track-info">
                    <div class="t-title">${t.name}</div>
                    <div class="t-meta">${t.cat}</div>
                </div>
                <div class="step-grid">
                    ${Array(16).fill(0).map((_,i) => `<div class="step" onclick="UIManager.togStep('${t.id}',${i},this)"></div>`).join('')}
                </div>
            `;
            document.getElementById('trackContainer').appendChild(div);

            // Mixer Strip
            const strip = document.createElement('div');
            strip.className = 'strip'; strip.id = `mx-${t.id}`;
            strip.innerHTML = `
                <div style="font-size:9px; color:#888; text-align:center; margin-bottom:5px;">${t.name.substr(0,10)}</div>
                <div class="fx-slot" onclick="UIManager.openFX('${t.id}', 'EQ')">EQ</div>
                <div class="fx-slot" onclick="UIManager.openFX('${t.id}', 'DIST')">DIST</div>
                <div class="fx-slot" onclick="UIManager.openFX('${t.id}', 'DELAY')">DELAY</div>
                <div class="fader-area">
                    <input type="range" class="vol" min="0" max="1" step="0.01" value="0.8" oninput="AudioCore.tracks.find(x=>x.id=='${t.id}').fx.vol=this.value">
                </div>
            `;
            const mixer = document.getElementById('mixerContainer');
            mixer.insertBefore(strip, mixer.lastElementChild);
        },
        
        togStep(tid, idx, el) {
            const t = AudioCore.tracks.find(x => x.id === tid);
            if(t) {
                t.steps[idx] = !t.steps[idx];
                el.classList.toggle('active');
            }
        },
        
        highlight(step) {
            document.querySelectorAll('.step.playhead').forEach(e => e.classList.remove('playhead'));
            document.querySelectorAll(`.step:nth-child(${step+1})`).forEach(e => e.classList.add('playhead'));
        },
        resetHeads() { document.querySelectorAll('.step.playhead').forEach(e => e.classList.remove('playhead')); },

        openFX(tid, type) {
            // Close existing
            const ex = document.getElementById('currPlugin');
            if(ex) ex.remove();

            const t = AudioCore.tracks.find(x => x.id === tid);
            if(!t) return;

            const win = document.createElement('div');
            win.className = 'plugin-win'; win.id = 'currPlugin';
            win.style.display = 'block';
            win.style.left = '30%'; win.style.top = '30%';
            
            // Generate Knobs based on type
            let knobs = '';
            if(type === 'EQ') {
                knobs = this.makeKnob('LOW', t.fx.eqLow, -20, 20, v=>t.fx.eqLow=v) +
                        this.makeKnob('MID', t.fx.eqMid, -20, 20, v=>t.fx.eqMid=v) +
                        this.makeKnob('HIGH', t.fx.eqHigh, -20, 20, v=>t.fx.eqHigh=v);
            } else if (type === 'DIST') {
                knobs = this.makeKnob('DRIVE', t.fx.dist, 0, 100, v=>t.fx.dist=v);
            } else if (type === 'DELAY') {
                knobs = this.makeKnob('TIME', t.fx.delayTime, 0, 100, v=>t.fx.delayTime=v) +
                        this.makeKnob('FDBK', t.fx.delayFeed, 0, 100, v=>t.fx.delayFeed=v);
            }

            win.innerHTML = `
                <div class="pw-head" onmousedown="UIManager.drag(event, 'currPlugin')">
                    ${t.name} - ${type} <span onclick="this.parentElement.parentElement.remove()">✕</span>
                </div>
                <div class="pw-body">${knobs}</div>
            `;
            document.getElementById('windowLayer').appendChild(win);
        },

        makeKnob(lbl, val, min, max, cb) {
            // Knob HTML generator
            // Not implemented full logic for brevity, functional slider instead
            return `
                <div class="knob-wrap">
                    <input type="range" min="${min}" max="${max}" value="${val}" 
                     oninput="(${cb})(parseFloat(this.value))" style="width:60px">
                    <div class="knob-txt">${lbl}</div>
                </div>
            `;
        },

        drag(e, id) {
            const el = document.getElementById(id);
            const x = e.clientX - el.offsetLeft; const y = e.clientY - el.offsetTop;
            const mv = (ev) => { el.style.left = (ev.clientX - x) + 'px'; el.style.top = (ev.clientY - y) + 'px'; };
            document.addEventListener('mousemove', mv);
            document.onmouseup = () => document.removeEventListener('mousemove', mv);
        }
    };

    // --- 7. BOOT SEQUENCE ---
    const System = {
        logs: [
            "KERNEL BAŞLATILIYOR...",
            "AUDIO CONTEXT OLUŞTURULDU (48kHz)",
            "YAPAY ZEKA MODÜLLERİ YÜKLENİYOR...",
            "NÖRAL AĞLAR BAĞLANIYOR...",
            "SPECTRAL ANALİZÖR HAZIR...",
            "R0Y-CLOUD BAĞLANTISI KURULDU.",
            "SİSTEM HAZIR. ERİŞİM BEKLENİYOR."
        ],
        async start() {
            const con = document.getElementById('bootLog');
            for(let log of this.logs) {
                con.innerHTML += `> ${log}<br>`;
                con.scrollTop = con.scrollHeight;
                await Utils.wait(600);
            }
            document.getElementById('enterBtn').style.display = 'block';
        },
        init() {
            AudioCore.init();
            document.getElementById('loader').style.display = 'none';
        }
    };

    window.onload = () => System.start();

</script>
</body>
</html>
